<!DOCTYPE html>
<html>
  <head>
    <title>Blackjack</title>
    <link href='styles.css' rel='stylesheet' />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  </head>
  <body>
    <script src="http://localhost:8080/libs/three.min.js"></script>
    <script src="http://localhost:8080/libs/Tween.js"></script>
    <script src="http://localhost:8080/libs/OrbitControls.js"></script>
    <script src="http://localhost:8080/libs/CSS3DRenderer.js"></script>

    <div id="container"></div>
    <div id="info">Blackjack<a href="http://www.praeses.com" target="_blank" rel="noopener">@Praeses</a></div>
    <div id="menu">
      <button id="HIT">Hit</button>
      <button id='STAND'>Stand</button>
      <button id="DOUBLE-DOWN">Double-Down</button>
      <button id="SPLIT">Split</button>
    </div>

    <script>

      /*this is the globalThis referred to as the 'table' in other modules. draw calls upon card movement
	and W/L conditions are directed here to the transform() function

      /*code remaining inlined here deals primarily with the scene setup and animation, and has been left
	separate from the game logic for that reason*/

      const root_dir = 'http://localhost:8080/';
      var Game = require(root_dir+'src/game.js');
      Game.table = this;
      var camera, scene, renderer, controls;
      var cards = Game.shoe.cards;
      var target_list = ['DEALER_1', 'DEALER_2', 'PLAYER1_1', 'PLAYER1_2', 'SHOE', 'DISCARD', 'MARKER'];
      //targets is a dict of THREE.Object3D, keyed by the capital names above
      var targets = {};

      var single_player_layout = {// column x row (x then y coord)
	  DEALER_1: [1,1],
	  DEALER_2: [2,1],
	  PLAYER1_1: [3,4],
	  PLAYER1_2: [4,4],
	  SHOE: [5,1],
	  DISCARD: [6,1],
	  MARKER: [5,0]
      };
      
      //set up tween targets for card animations
      //single player
      for (const t of target_list) {
	  var move_target = new THREE.Object3D();
	  move_target.position.x = (140 * single_player_layout[t][0]-800);
	  move_target.position.y = -(175 * single_player_layout[t][1])+650;
	  targets[t]=move_target;
      }
      
      function init() {
        camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
        camera.position.z = 1500;
        scene = new THREE.Scene();

	//keep for now in case we want to implement a felt pattern
        /*var background_map=document.createElement('img');
        background_map.src='../images/usmap_states.png';
        var obj= new THREE.CSS3DObject(background_map);
        obj.position.x=0;
        obj.position.y=0;
        obj.position.z=-5;
        scene.add(obj);*/
	  
	for (let crd of cards.values()) {
	  var card=document.createElement('div');
	  var card_img=document.createElement('img');
	  card_img.src="http://localhost:8080/assets/DVinfernoMegaeraTisifphoneAlecto_s.png";
	  card_img.width=120;
	    card_img.height=155;
	    card_img.className
	  card.className = 'card';
	  card.appendChild(card_img);
	  //need to add code here to make cards <a/> to https://en.wikipedia.org/wiki/Playing_card		     
          //card.onclick="document.location='../periodic_table.html'"   
          //card.addEventListener("onmouseover",hover(card,3));
          var cardvalue = document.createElement( 'div' );
          cardvalue.className = 'card.value';
          teamrank.textContent = teamranknumber;
          teamrank.style.color=teams[i+4];
          card.appendChild(teamrank);
          var suitlogo = document.createElement( 'img' );
          teamlogo.className= 'card.logo';
	  //.src should point to one of the four suit logos
          suitlogo.src=teams[i+10];
          card.appendChild(suitlogo);

	  var card_obj = new THREE.CSS3DObject( card );
	  crd.doc_element = card_obj
          //object.addEventListener("mouseenter",function () {this.position.z=500;render();});
          //object.addEventListener("mouseout",function () {this.position.z=0;render();});

	  //give the cards starting exploded positions
	  object.position.x = Math.random() * 4000 - 2000;
          object.position.y = Math.random() * 4000 - 2000;
          object.position.z = 0;
          scene.add( object );
          objects[teams[i]]= object ;
          //
          
        }
        
        renderer = new THREE.CSS3DRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.domElement.style.position = 'absolute';
        document.getElementById( 'container' ).appendChild( renderer.domElement );

        controls = new THREE.OrbitControls( camera, renderer.domElement );
        //controls.noRotate = true;
        controls.rotateSpeed = 0.5;
        controls.minDistance = 200;
        controls.maxDistance = 2500;
        controls.addEventListener( 'change', render );
        
        var button = document.getElementById( 'HIT' );
        button.addEventListener( 'click', function ( event ) {
            handle_hit();
          }, false );
        var button = document.getElementById( 'STAND' );
        button.addEventListener( 'click', function ( event ) {
            handle_stand();
        }, false );
        var button = document.getElementById( 'DOUBLE-DOWN' );
	button.style.visibility='hidden';
        button.addEventListener( 'click', function ( event ) {
            handle_dd();
        }, false );
        var button = document.getElementById( 'SPLIT' );
	button.style.visibility='hidden';
        button.addEventListener( 'click', function ( event ) {
            handle_split();
        }, false );
	  
        transform( targets.TABLE, 2000 );
        //
        window.addEventListener( 'resize', onWindowResize, false );
      }

      //maybe we should respond to keypresses rather than button clicks? H for hit, S for stand?
      
      function handle_hit(){
	  //insert code to hit the current player with a card when button is pressed
	  Game.hit();
      }

      function handle_stand(){
	  //insert code to move to the next available player
	  Game.stand();
      }

      function handle_dd(){
	  //insert code to handle a double down
	  //TODO
      }

      function handle_split(){
	  //insert code to handle a split
	  //TODO
      }

      function end_game(){
	  //insert code to stop game, present banner with name, reset everything
	  //this will be called by game when it detects a win
	  //
	  //insert banner movement code here
	  //TODO
	  window.close();
      }
      
      function transform(card, duration=1000 ) {
        TWEEN.removeAll();
        
        new TWEEN.Tween( card.doc_element.position )
          .to( { x: targets[card.new_position].position.x, y: targets[card.new_position].position.y, z: targets[card.new_position].position.z }, Math.random() * duration + duration )
          .easing( TWEEN.Easing.Exponential.InOut )
          .start();
        new TWEEN.Tween( card.doc_element.rotation )
          .to( { x: targets[card.new_position].rotation.x, y: targets[card.new_position].rotation.y, z: targets[card.new_position].rotation.z }, Math.random() * duration + duration )
          .easing( TWEEN.Easing.Exponential.InOut )
          .start();
        new TWEEN.Tween( this )
          .to( {}, duration * 2 )
          .onUpdate( render )
          .start();
      }
      
      function hover( obj,scalex ){
        obj.scale.set( scalex, scalex, scalex );
      }
      
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );
        render();
      }
      
      function animate() {
        requestAnimationFrame( animate );
        TWEEN.update();
        controls.update();
      }
      
      function render() {
        renderer.render( scene, camera );
      }

      init();
      animate();

      //while the game hasn't been won, continue to play hands
      while (!Game.game_over){
	  Game.play_hand();
      }

      end_game();
      
    </script>
  </body>
</html>
