<!DOCTYPE html>
<html>
  <head>
    <title>Blackjack</title>
    <link href='styles.css' rel='stylesheet' />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  </head>
  <body>
    <script src="http://localhost:8080/libs/three.min.js"></script>
    <script src="http://localhost:8080/libs/Tween.js"></script>
    <script src="http://localhost:8080/libs/OrbitControls.js"></script>
    <script src="http://localhost:8080/libs/CSS3DRenderer.js"></script>

    <div id="container"></div>
    <div id="info">Blackjack<a href="http://www.praeses.com" target="_blank" rel="noopener">@Praeses</a></div>
    <div id="menu">
      <button id="HIT">Hit</button>
      <button id='STAND'>Stand</button>
      <button id="DOUBLE-DOWN">Double-Down</button>
      <button id="SPLIT">Split</button>
    </div>

    <script>

      const root_dir = 'http://localhost:8080/';

      var single_player_layout = {// column x row (x then y coord)
	  DEALER_1: [1,1],
	  DEALER_2: [2,1],
	  PLAYER1_1: [3,4],
	  PLAYER1_2: [4,4],
	  SHOE: [5,1],
	  DISCARD: [6,1],
	  MARKER: [5,0]
      };

      var camera, scene, renderer, controls;
      var objects = {};
      var target_list = ['DEALER_1', 'DEALER_2', 'PLAYER1_1', 'PLAYER1_2', 'SHOE', 'DISCARD', 'MARKER'];
      var targets = {};
      
      //set up tween targets for card animations
      for (const t of target_list) {
	  var move_target = new THREE.Object3D();
	  move_target.position.x = (140 * single_player_layout.t[0]-800);
	  move_target.position.y = -(175 * single_player_layout.t[1])+650;
	  targets.t=move_target;
      }
      
      init();
      animate();

      
      function init() {
        camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 10000 );
        camera.position.z = 1500;
        scene = new THREE.Scene();

	//keep for now in case we want to implement a felt pattern
        /*var background_map=document.createElement('img');
        background_map.src='../images/usmap_states.png';
        var obj= new THREE.CSS3DObject(background_map);
        obj.position.x=0;
        obj.position.y=0;
        obj.position.z=-5;
        scene.add(obj);*/
      
          // single_player

	for (let crd of cards.values()) {
	  var card=document.createElement('div');
	  var card_img=document.createElement('img');
	  card_img.src="http://localhost:8080/assets/DVinfernoMegaeraTisifphoneAlecto_s.png";
	  card_img.width=120;
	  card_img.height=155;
	  card.className = 'card';
	  card.appendChild(card_img);
	  //need to add code here to make cards <a/> to https://en.wikipedia.org/wiki/Playing_card		     
          //team.onclick="document.location='../periodic_table.html'"   
          //team.addEventListener("onmouseover",hover(team,3));
          var wlrecord = document.createElement( 'div' );
          wlrecord.className = 'wlrecord';
          wlrecord.textContent = teams[i+8];
          wlrecord.style.color=teams[i+4];
          team.appendChild( wlrecord );
          var teamrank = document.createElement( 'div' );
          if (teams[i+9]=='0') {
            teamrankcounter+=1;
            var teamranknumber=teamrankcounter+25;
          }
          else {
            var teamranknumber=teams[i+9];
          }
          teamrank.className = 'teamrank';
          teamrank.textContent = teamranknumber;
          teamrank.style.color=teams[i+4];
          team.appendChild(teamrank);
          var teamlogo = document.createElement( 'img' );
          teamlogo.className= 'teamlogo';
          teamlogo.src=teams[i+10];
          team.appendChild(teamlogo);
          var teamname = document.createElement( 'div' );
          teamname.className = 'teamname';
          teamname.style.color=teams[i+4];
          teamname.innerHTML = teams[ i + 1 ] + '<br>' + teams[ i + 2 ];
          team.appendChild( teamname );

	  var card_obj = new THREE.CSS3DObject( card );
          //object.addEventListener("mouseenter",function () {this.position.z=500;render();});
          //object.addEventListener("mouseout",function () {this.position.z=0;render();});
          object.position.x = Math.random() * 4000 - 2000;
          object.position.y = Math.random() * 4000 - 2000;
          object.position.z = 0;
          scene.add( object );
          objects[teams[i]]= object ;
          //
          
        }

        //reset counter for top25 determination
        teamrankcounter=0;

        // top 25
        for ( var i = 0, l = Object.keys(objects).length; i < (l*11); i +=11 ) {

          if (teams[i+9]=='0') {
            teamrankcounter+=1;
            teamranknumber=teamrankcounter+25;
          }
          else {
            teamranknumber=teams[i+9];
          }
          var object = new THREE.Object3D();
          if (teamranknumber<=25) {
            object.position.x = (top25[(teamranknumber-1)*2] * 140) - 470;
            object.position.y = -(top25[(teamranknumber-1)*2+1] * 180)+530;
            targets.TOP25[teams[i]]=object;
          }
          else {
            object.position.x = Math.random() * 4000 -2000;
            object.position.y = Math.random() * 4000 -2000;
            object.position.z = 4000;
            targets.TOP25[teams[i]]=object;
          }
        }
        
        // matchups
        var vector = new THREE.Vector3();
        var cylindrical = new THREE.Cylindrical();
        for ( var i = 0, l = objects.length; i < l; i ++ ) {
          var theta = i * 0.175 + Math.PI;
          var y = - ( i * 8 ) + 450;
          var object = new THREE.Object3D();
          cylindrical.set( 900, theta, y );
          object.position.setFromCylindrical( cylindrical );
          vector.x = object.position.x * 2;
          vector.y = object.position.y;
          vector.z = object.position.z * 2;
          object.lookAt( vector );
          targets.WEEKLY_MATCHUP.push( object );
        }
        
        renderer = new THREE.CSS3DRenderer();
        renderer.setSize( window.innerWidth, window.innerHeight );
        renderer.domElement.style.position = 'absolute';
        document.getElementById( 'container' ).appendChild( renderer.domElement );

        controls = new THREE.OrbitControls( camera, renderer.domElement );
        //controls.noRotate = true;
        controls.rotateSpeed = 0.5;
        controls.minDistance = 500;
        controls.maxDistance = 6000;
        controls.addEventListener( 'change', render );
        
        var button = document.getElementById( 'HIT' );
        button.addEventListener( 'click', function ( event ) {
            handle_hit();
          }, false );
        var button = document.getElementById( 'STAND' );
        button.addEventListener( 'click', function ( event ) {
            handle_stand();
        }, false );
        var button = document.getElementById( 'DOUBLE-DOWN' );
        button.addEventListener( 'click', function ( event ) {
            handle_dd();
        }, false );
        var button = document.getElementById( 'SPLIT' );
        button.addEventListener( 'click', function ( event ) {
            handle_split();
        }, false );
	  
        transform( targets.TABLE, 2000 );
        //
        window.addEventListener( 'resize', onWindowResize, false );
      }

      function handle_hit(){
	  //insert code to hit the current player with a card when button is pressed
      }

      function handle_stand(){
	  //insert code to move to the next available player
      }

      function handle_dd(){
	  //insert code to handle a double down
      }

      function handle_split(){
	  //insert code to handle a split
      }
      
      function transform( targets, duration ) {
        TWEEN.removeAll();

        for (var key in targets) {
          var object = objects[key];
          var target = targets[key];
          new TWEEN.Tween( object.position )
            .to( { x: target.position.x, y: target.position.y, z: target.position.z }, Math.random() * duration + duration )
            .easing( TWEEN.Easing.Exponential.InOut )
            .start();
          new TWEEN.Tween( object.rotation )
            .to( { x: target.rotation.x, y: target.rotation.y, z: target.rotation.z }, Math.random() * duration + duration )
            .easing( TWEEN.Easing.Exponential.InOut )
            .start();

        }
        new TWEEN.Tween( this )
          .to( {}, duration * 2 )
          .onUpdate( render )
          .start();
      }
      
      function hover( obj,scalex ){
        obj.scale.set( scalex, scalex, scalex );
      }
      
      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize( window.innerWidth, window.innerHeight );
        render();
      }
      
      function animate() {
        requestAnimationFrame( animate );
        TWEEN.update();
        controls.update();
      }
      
      function render() {
        renderer.render( scene, camera );
      }
    </script>
  </body>
</html>
